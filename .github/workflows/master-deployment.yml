on:
  push:
    branches:
      - dev

name: ðŸš€ Deploy Homolog

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      -
        name: ðŸšš Get latest code
        uses: actions/checkout@v4

      -
        name: ðŸ“‚ Backup Current Files
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          use_insecure_cipher: true
          cipher: aes256-cbc
          script: |
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_DIR="app/dev-criomec-v2-releases/versions/${TIMESTAMP}"

            echo "âš¡ Creating backup of current deployment..."
            mkdir -p $BACKUP_DIR
            cp -r app/dev-criomec-v2/* $BACKUP_DIR/

            echo "âœ… Backup created at: $BACKUP_DIR"

      -
        name: ðŸ“‚ Backup Database Before Deployment
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          use_insecure_cipher: true
          cipher: aes256-cbc
          script: |
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_DB_PATH="app/dev-criomec-v2-releases/versions/db_backup_${TIMESTAMP}.sql"

            echo "âš¡ Creating database backup..."
            mysqldump -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} > $BACKUP_DB_PATH

            echo "âœ… Database backup saved: $BACKUP_DB_PATH"

      -
        name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: app/dev-criomec-v2/
