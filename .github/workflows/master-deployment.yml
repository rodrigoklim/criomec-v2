on:
  push:
    branches:
      - dev

name: üöÄ Deploy Homolog

jobs:
  web-deploy:
    name: üéâ Deploy
    runs-on: ubuntu-latest
    steps:
      -
        name: üöö Get latest code
        uses: actions/checkout@v4

      -
        name: üìÇ Backup Current Files
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          use_insecure_cipher: true
          cipher: aes256-cbc
          script: |
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_DIR="app/dev-criomec-v2-releases/versions/${TIMESTAMP}"

            echo "‚ö° Creating backup of current deployment..."
            mkdir -p $BACKUP_DIR
            cp -r app/dev-criomec-v2/* $BACKUP_DIR/

            echo "‚úÖ Backup created at: $BACKUP_DIR"

      -
        name: üìÇ Backup Database Before Deployment
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          use_insecure_cipher: true
          cipher: aes256-cbc
          script: |
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_DB_PATH="app/dev-criomec-v2-releases/versions/db_backup_${TIMESTAMP}.sql"

            echo "‚ö° Creating database backup..."
            mysqldump -u ${{ secrets.DB_USERNAME }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} > $BACKUP_DB_PATH

            echo "‚úÖ Database backup saved: $BACKUP_DB_PATH"

      -
        name: üìÇ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: dev-criomec-v2/

      -
        name: üñ•Ô∏è Run Composer on Server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          use_insecure_cipher: true
          cipher: aes256-cbc
          script: |
            cd  app/dev-criomec-v2/
            composer install --no-dev --optimize-autoloader --no-interaction
            echo "‚úÖ Composer install completed"

      -
        name: üõ†Ô∏è Run Migrations
        uses: appleboy/ssh-action@v0.1.10
        id: migrate
        continue-on-error: true
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          use_insecure_cipher: true
          cipher: aes256-cbc
          script: |
            cd app/dev-criomec-v2/
            php artisan migrate --force
            echo "‚úÖ Database migrations executed successfully"

      -
        name: ‚ùå Rollback on Failure
        if: steps.migrate.outcome == 'failure'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          use_insecure_cipher: true
          cipher: aes256-cbc
          script: |
            echo "üö® Migration failed! Rolling back to previous version..."

            TIMESTAMP=$(ls -t app/dev-criomec-v2/versions | head -n 1)
            BACKUP_DIR="app/dev-criomec-v2/versions/$TIMESTAMP"

            if [ -d "$BACKUP_DIR" ]; then
              rm -rf app/dev-criomec-v2/*
              cp -r $BACKUP_DIR/* app/dev-criomec-v2/
              echo "‚úÖ Rolled back to previous version: $TIMESTAMP"
            else
              echo "‚ö†Ô∏è No valid backup found, rollback skipped!"
            fi

            echo "‚ö° Restoring database backup..."
            mysql -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} < " app/dev-criomec-v2/versions/db_backup_${TIMESTAMP}.sql"
            echo "‚úÖ Database restored!"

      -
        name: ‚ôªÔ∏è Restart Queue Workers
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          use_insecure_cipher: true
          cipher: aes256-cbc
          script: |
            cd  app/dev-criomec-v2/
            php artisan queue:restart
            echo "‚úÖ Queue workers restarted"
